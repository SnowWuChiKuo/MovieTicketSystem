@model ClientSide.Models.ViewModels.CartVm

@{
    ViewBag.Title = "訂票夾";
}
<style>
    .card1 {
        margin-top: 40px;
        border: 1px solid #ddd;
        padding: 10px;
        display: flex;
        box-shadow: rgb(0, 0, 0) 5px 5px 20px;
    }

    .card2 {
        border: 1px solid #ddd;
        padding: 10px;
        display: flex;
        align-items: center;
        margin: 10px;
        justify-content: space-between;
    }

        .card2 img {
            max-width: 100px;
            display: flex;
            max-height: 100px;
        }

    .movie-info {
        margin: 0 10px;
        display: flex;
        /*  display: flex;  移除此行*/
        /*  align-items: center; 移除此行*/
        text-align: center; /* 新增此行*/
    }

        .movie-info p {
            margin: 0 10px;
            white-space: nowrap;
        }

    .right-items {
        display: flex;
        text-align: right;
        /*移除 flexbox 設定*/
    }
</style>
<div class="container mt-5" style="margin-bottom:200px">
    <div style="display: flex; flex: 1;">
        <div style="flex: 1; padding: 20px;">
            @* 訂票夾標題 *@
            <h2 style="text-align: center; margin-bottom: 20px;" class="fw-bolder">訂票夾</h2>
            @{
                if (Model != null && Model.CartItems != null && Model.CartItems.Any())
                {
                    <div class="card1 card container">
                        @foreach (var item in Model.CartItems)
                        {
                            <div class="card2  ">
                                <div style="margin-right: 10px;" class="">
                                    <img src="~/MoviePosters/@item.ImgPath" alt="Movie Image" style="max-width: 100px; max-height: 100px;" />
                                </div>
                                <div class="movie-info">
                                    <p style="margin-right:50px"><b>電影:</b> @item.MovieTitle </p>
                                    <p><b>時間:</b> @item.MovieTime</p>
                                </div>
                                <div class="right-items">
                                    <a href="~/CartItems/Detail/@item.Id" class="btn btn-sm btn-outline-primary ">>進入票卷</a>
                                    @*Get method*@
                                    <a class="btn btn-danger ms-3" href="~/CartItems/DeleteCartItem?id=@item.Id">刪除</a>
                                </div>
                            </div>
                        }
                    </div>
                    <div class="text-center " style="margin-top: 80px">
                        @*<form asp-action="Checkout" id="deleteUserForm">
            <div class="mb-3">
                <input type="hidden" name="cartId" value="@Model.Id" />
                <input type="submit" value="前往結帳" class="btn btn-success" />
            </div>
        </form>*@
                        @*Get method*@
                        @{
                            // 從 Session 獲取參數而不是 URL
                            var seatIds = Session["SeatIds"] ?? "";
                            var screeningId = Session["ScreeningId"] ?? "";
                        }
                        <a class="btn btn-success" href="~/Carts/Checkout?cartId=@Model.Id&seatIds=@seatIds&screeningId=@screeningId">前往結帳</a>
                    </div>
                }
                else
                {
                    <div class="card1 card" style="align-items: center; height:500px;">
                        <h1 style="text-align: center; margin-top: 100px;" class="" asp-action="Checkout">訂票夾是空的</h1>
                    </div>
                }
            }
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
       @if (TempData["ErrorMessage"] != null)
        {
            @:Swal.fire({
            @:  icon: 'error',
            @:  title: '錯誤!',
            @:  text: '@TempData["ErrorMessage"]',
            @:});
            @:Console.log('@TempData["ErrorMessage"]');
        }

        // 從 sessionStorage 獲取值
        const seatIds = sessionStorage.getItem('seatIds');
        const screeningId = sessionStorage.getItem('screeningId');

        // 獲取結帳按鈕
        const checkoutBtn = document.querySelector('.btn-success');

        if (checkoutBtn && seatIds && screeningId) {
            // 更新結帳按鈕的 href
            const baseHref = checkoutBtn.getAttribute('href').split('?')[0];
            const newHref = `${baseHref}?cartId=@Model.Id&seatIds=${seatIds}&screeningId=${screeningId}`;
            checkoutBtn.setAttribute('href', newHref);
        }

    });
</script>

